<?xml version="1.0" encoding="UTF-8"?>
<webApp>
    <containers> 
        <webContainer>
            <name>web</name>
            <requires>business</requires>
            <docker>
            	<image>dio/nginx_jre:v1</image>
            	<mntBindVols>
	            	<mntBindVol accessMode="rw">
	            		<srcPath>/home/dio/THESIS/maestro/core/src/main/resources</srcPath>
	            		<dstPath>/broker</dstPath>
	            	</mntBindVol>
            	</mntBindVols>
            	<privileged>true</privileged>
            </docker>
            <start>
                <preMain abortOnFail="true">cp /broker/testCases/crudApp/webTier/nginx.conf /etc/nginx/nginx.conf</preMain>
                <main>nginx -g "daemon off;"</main>
            </start>
            <stop>
                <main>nginx -s quit</main>
                <postMain>/broker/testCases/crudApp/webTier/restore_template.sh</postMain>
            </stop>
            <tasks>
                <substEnv>/broker/testCases/crudApp/webTier/nginx.conf</substEnv>
            </tasks>
            <env>
                <host_port>80</host_port>
            </env>
        </webContainer>
        <businessContainer>
            <name>business</name> 
            <requires>data</requires>
            <docker>
            	<image>glassfish</image>
            	<mntBindVols>
	            	<mntBindVol>
	            		<srcPath>/home/dio/THESIS/maestro/core/src/main/resources</srcPath>
	            		<dstPath>/broker</dstPath>
	            	</mntBindVol>
            	</mntBindVols>
            	<publishPorts>
            		<publishPort protocol="tcp">
            			<ip>127.0.0.1</ip>
            			<hostPort>8080</hostPort>
	            		<containerPort>8080</containerPort>
	            	</publishPort>
            	</publishPorts>
            	<privileged>true</privileged>
            </docker>
            <start>
                <main>/broker/testCases/crudApp/BusinessTier/business-entrypoint.sh</main>
                <postMain abortOnFail="true">asadmin add-resources /broker/testCases/crudApp/BusinessTier/glassfish-resources.xml</postMain>
                <postMain abortOnFail="true">asadmin deploy /broker/testCases/crudApp/BusinessTier/ConsultingAgency.war</postMain>
            </start>
            <stop>
                <preMain>asadmin undeploy ConsultingAgency</preMain>
                <preMain>/broker/testCases/crudApp/BusinessTier/delete_resources.sh</preMain>
                <main>asadmin stop-domain domain1</main>
                <postMain>/broker/testCases/crudApp/BusinessTier/restore_template.sh</postMain>
            </stop>
            <tasks>
                <substEnv>/broker/testCases/crudApp/BusinessTier/glassfish-resources.xml</substEnv>
            </tasks>
            <env>
                <host_port>8080</host_port>
                <app_name>ConsultingAgency</app_name>
            </env>
        </businessContainer>
        <dataContainer>
            <name>data</name>
            <docker>
            	<image>dio/mysql_jre:v2</image>
            	<mntBindVols>
	            	<mntBindVol>
	            		<srcPath>/home/dio/THESIS/maestro/core/src/main/resources</srcPath>
	            		<dstPath>/broker</dstPath>
	            	</mntBindVol>
            	</mntBindVols>
            	<privileged>true</privileged>
            </docker>
            <start>
                <main>/broker/testCases/crudApp/dataTier/data-entrypoint.sh mysqld</main>
            </start>
            <stop>
                <main>service mysql stop</main>
            </stop>
            <env>
                <host_port>3306</host_port>
                <db_user>root</db_user>
                <db_pass>root</db_pass>
                <db_name>consult</db_name>
                <db_driver/>
            </env>
        </dataContainer>
    </containers>
</webApp>